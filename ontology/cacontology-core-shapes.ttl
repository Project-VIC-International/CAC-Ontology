@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix uco-core: <https://ontology.unifiedcyberontology.org/uco/core/> .
@prefix uco-observable: <https://ontology.unifiedcyberontology.org/uco/observable/> .
@prefix uco-action: <https://ontology.unifiedcyberontology.org/uco/action/> .
@prefix uco-role: <https://ontology.unifiedcyberontology.org/uco/role/> .
@prefix uco-identity: <https://ontology.unifiedcyberontology.org/uco/identity/> .
@prefix case-investigation: <https://ontology.caseontology.org/case/investigation/> .
@prefix cacontology: <https://cacontology.projectvic.org#> .
@prefix cacontology-gufo: <https://cacontology.projectvic.org/gufo#> .
@prefix cacontology-temporal: <https://cacontology.projectvic.org/temporal#> .
@prefix gufo: <http://purl.org/nemo/gufo#> .
@prefix dcterms: <http://purl.org/dc/terms/> .

# =============================================================================
# ONTOLOGY DECLARATION
# =============================================================================

<https://cacontology.projectvic.org/core/shapes/2.2.0> rdf:type owl:Ontology ;
    rdfs:label "CAC Core SHACL Shapes with gUFO Validation"@en ;
    rdfs:comment "Comprehensive SHACL validation shapes for gUFO-enhanced ICAC core ontology, including anti-rigidity constraints, temporal validation, phase transitions, and foundational type compliance."@en ;
    owl:versionIRI <https://cacontology.projectvic.org/core/shapes/2.2.0> ;
    dcterms:creator "CAC Ontology Team" ;
    dcterms:modified "2025-11-18"^^xsd:date ;
    owl:imports <https://cacontology.projectvic.org/gufo/2.2.0> ,
                <http://purl.org/nemo/gufo> ,
                <https://ontology.unifiedcyberontology.org/uco/core/> .

# =============================================================================
# gUFO INVESTIGATION VALIDATION
# =============================================================================

# Investigation Shape with gUFO Kind validation
cacontology-gufo:InvestigationShape rdf:type sh:NodeShape ;
    rdfs:label "gUFO Investigation Shape"@en ;
    sh:targetClass cacontology-gufo:Investigation ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:Kind ;
        sh:minCount 1 ;
        sh:message "Investigation must be typed as gUFO Kind"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:inPhase ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class gufo:Phase ;
        sh:message "Investigation must be in exactly one phase"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:hasRole ;
        sh:minCount 1 ;
        sh:class gufo:Role ;
        sh:message "Investigation must have at least one role"@en
    ] .

# =============================================================================
# gUFO PHASE VALIDATION (Anti-Rigid Sortals)
# =============================================================================

# Base Phase Shape
cacontology-gufo:PhaseShape rdf:type sh:NodeShape ;
    rdfs:label "gUFO Phase Shape"@en ;
    sh:targetClass gufo:Phase ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:Phase ;
        sh:minCount 1 ;
        sh:message "Phase must be typed as gUFO Phase (anti-rigid sortal)"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:hasPhaseBeginPoint ;
        sh:datatype xsd:dateTimeStamp ;
        sh:maxCount 1 ;
        sh:message "Phase can have at most one begin point"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:hasPhaseEndPoint ;
        sh:datatype xsd:dateTimeStamp ;
        sh:maxCount 1 ;
        sh:message "Phase can have at most one end point"@en
    ] ;
    # Temporal consistency: begin must precede end
    sh:sparql [
        sh:message "Phase begin point must precede end point"@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "cacontology-gufo" ;
                sh:namespace "https://cacontology.projectvic.org/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            PREFIX cacontology-gufo: <https://cacontology.projectvic.org/gufo#>
            SELECT ?this
            WHERE {
                ?this cacontology-gufo:hasPhaseBeginPoint ?begin ;
                      cacontology-gufo:hasPhaseEndPoint ?end .
                FILTER (?begin >= ?end)
            }
        """
    ] .

# Specific Phase Shapes
cacontology-gufo:InitialPhaseShape rdf:type sh:NodeShape ;
    rdfs:label "Initial Phase Shape"@en ;
    sh:targetClass cacontology-gufo:InitialPhase ;
    sh:property [
        sh:path cacontology-gufo:hasPhaseBeginPoint ;
        sh:minCount 1 ;
        sh:message "Initial phase must have begin point"@en
    ] .

cacontology-gufo:CompletedPhaseShape rdf:type sh:NodeShape ;
    rdfs:label "Completed Phase Shape"@en ;
    sh:targetClass cacontology-gufo:CompletedPhase ;
    sh:property [
        sh:path cacontology-gufo:hasPhaseEndPoint ;
        sh:minCount 1 ;
        sh:message "Completed phase must have end point"@en
    ] .

# Phase Transition Validation
cacontology-gufo:PhaseTransitionShape rdf:type sh:NodeShape ;
    rdfs:label "Phase Transition Shape"@en ;
    sh:targetClass cacontology-gufo:Investigation ;
    sh:sparql [
        sh:message "Investigation phases must follow valid transition sequence"@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "cacontology-gufo" ;
                sh:namespace "https://cacontology.projectvic.org/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this cacontology-gufo:hasPhase ?phase1 ;
                      cacontology-gufo:hasPhase ?phase2 .
                ?phase1 cacontology-gufo:precedesPhase ?phase2 ;
                        cacontology-gufo:hasPhaseEndPoint ?end1 .
                ?phase2 cacontology-gufo:hasPhaseBeginPoint ?begin2 .
                FILTER (?end1 > ?begin2)
            }
        """
    ] .

# =============================================================================
# gUFO ROLE VALIDATION (Anti-Rigid Sortals)
# =============================================================================

# Base Role Shape
cacontology-gufo:RoleShape rdf:type sh:NodeShape ;
    rdfs:label "gUFO Role Shape"@en ;
    sh:targetClass gufo:Role ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:Role ;
        sh:minCount 1 ;
        sh:message "Role must be typed as gUFO Role (anti-rigid sortal)"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:hasRoleBeginPoint ;
        sh:datatype xsd:dateTimeStamp ;
        sh:maxCount 1 ;
        sh:message "Role can have at most one begin point"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:hasRoleEndPoint ;
        sh:datatype xsd:dateTimeStamp ;
        sh:maxCount 1 ;
        sh:message "Role can have at most one end point"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:participatesInInvestigation ;
        sh:minCount 0 ;
        sh:class cacontology-gufo:Investigation ;
        sh:message "Role must participate in at least one investigation"@en
    ] .

# Specific Role Shapes
cacontology-gufo:VictimRoleShape rdf:type sh:NodeShape ;
    rdfs:label "Victim Role Shape"@en ;
    sh:targetClass cacontology-gufo:VictimRole ;
    sh:property [
        sh:path cacontology-gufo:hasRoleBeginPoint ;
        sh:minCount 1 ;
        sh:message "Victim role must have begin point (when victimization started)"@en
    ] .

cacontology-gufo:OffenderRoleShape rdf:type sh:NodeShape ;
    rdfs:label "Offender Role Shape"@en ;
    sh:targetClass cacontology-gufo:OffenderRole ;
    sh:property [
        sh:path cacontology-gufo:hasRoleBeginPoint ;
        sh:minCount 1 ;
        sh:message "Offender role must have begin point (when offense started)"@en
    ] .

# Role Exclusivity Validation
cacontology-gufo:RoleExclusivityShape rdf:type sh:NodeShape ;
    rdfs:label "Role Exclusivity Shape"@en ;
    sh:targetClass cacontology-gufo:Person ;
    sh:sparql [
        sh:message "Person cannot simultaneously be victim and offender in same investigation"@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "cacontology-gufo" ;
                sh:namespace "https://cacontology.projectvic.org/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this cacontology-gufo:playsRole ?victimRole ;
                      cacontology-gufo:playsRole ?offenderRole .
                ?victimRole a cacontology-gufo:VictimRole ;
                           cacontology-gufo:participatesInInvestigation ?investigation .
                ?offenderRole a cacontology-gufo:OffenderRole ;
                             cacontology-gufo:participatesInInvestigation ?investigation .
            }
        """
    ] .

# =============================================================================
# gUFO EVENT VALIDATION
# =============================================================================

# Base Event Shape
cacontology-gufo:EventShape rdf:type sh:NodeShape ;
    rdfs:label "gUFO Event Shape"@en ;
    sh:targetClass gufo:Event ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:Event ;
        sh:minCount 1 ;
        sh:message "Event must be typed as gUFO Event"@en
    ] ;
    sh:property [
        sh:path gufo:hasBeginPointInXSDDateTimeStamp ;
        sh:datatype xsd:dateTimeStamp ;
        sh:maxCount 1 ;
        sh:message "Event can have at most one begin point"@en
    ] ;
    sh:property [
        sh:path gufo:hasEndPointInXSDDateTimeStamp ;
        sh:datatype xsd:dateTimeStamp ;
        sh:maxCount 1 ;
        sh:message "Event can have at most one end point"@en
    ] .

# Investigation Event Shapes
cacontology-gufo:ReceiveCybertipEventShape rdf:type sh:NodeShape ;
    rdfs:label "Receive Cybertip Event Shape"@en ;
    sh:targetClass cacontology-gufo:ReceiveCybertipEvent ;
    sh:property [
        sh:path uco-core:hasFacet ;
        sh:minCount 1 ;
        sh:message "Receive cybertip event must have at least one facet"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:occursInSituation ;
        sh:class cacontology-gufo:InvestigationPendingSituation ;
        sh:message "Receive cybertip should occur in pending situation"@en
    ] .

cacontology-gufo:ReviewCybertipEventShape rdf:type sh:NodeShape ;
    rdfs:label "Review Cybertip Event Shape"@en ;
    sh:targetClass cacontology-gufo:ReviewCybertipEvent ;
    sh:property [
        sh:path uco-action:performer ;
        sh:minCount 1 ;
        sh:class cacontology-gufo:InvestigatorRole ;
        sh:message "Review cybertip event must have investigator performer"@en
    ] .

cacontology-gufo:VictimRescueEventShape rdf:type sh:NodeShape ;
    rdfs:label "Victim Rescue Event Shape"@en ;
    sh:targetClass cacontology-gufo:VictimRescueEvent ;
    sh:property [
        sh:path uco-action:performer ;
        sh:minCount 1 ;
        sh:class cacontology-gufo:RescuerRole ;
        sh:message "Victim rescue event must have rescuer performer"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:createsSituation ;
        sh:class gufo:Situation ;
        sh:message "Rescue event should create situation"@en
    ] .

# =============================================================================
# gUFO SITUATION VALIDATION
# =============================================================================

# Base Situation Shape
cacontology-gufo:SituationShape rdf:type sh:NodeShape ;
    rdfs:label "gUFO Situation Shape"@en ;
    sh:targetClass gufo:Situation ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:Situation ;
        sh:minCount 1 ;
        sh:message "Situation must be typed as gUFO Situation"@en
    ] .

# Investigation Lifecycle Situation Shapes
cacontology-gufo:InvestigationActiveSituationShape rdf:type sh:NodeShape ;
    rdfs:label "Investigation Active Situation Shape"@en ;
    sh:targetClass cacontology-gufo:InvestigationActiveSituation ;
    sh:sparql [
        sh:message "Active investigation situation must correspond to active phase"@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "cacontology-gufo" ;
                sh:namespace "https://cacontology.projectvic.org/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this a cacontology-gufo:InvestigationActiveSituation .
                ?investigation cacontology-gufo:inPhase ?phase .
                FILTER NOT EXISTS {
                    ?phase a cacontology-gufo:AnalysisPhase .
                } FILTER NOT EXISTS {
                    ?phase a cacontology-gufo:LegalProcessPhase .
                } FILTER NOT EXISTS {
                    ?phase a cacontology-gufo:EvidencePhase .
                } FILTER NOT EXISTS {
                    ?phase a cacontology-gufo:ResolutionPhase .
                }
            }
        """
    ] .

# =============================================================================
# CRIMINAL EVENT VALIDATION WITH gUFO
# =============================================================================

# Base Criminal Event Shape
cacontology-gufo:ChildSexualAbuseEventShape rdf:type sh:NodeShape ;
    rdfs:label "Child Sexual Abuse Event Shape"@en ;
    sh:targetClass cacontology-gufo:ChildSexualAbuseEvent ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:Kind ;
        sh:minCount 1 ;
        sh:message "Child Sexual Abuse Event must be gUFO Kind"@en
    ] ;
    sh:sparql [
        sh:message "Criminal event must involve victim and offender roles"@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "cacontology-gufo" ;
                sh:namespace "https://cacontology.projectvic.org/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this a cacontology-gufo:ChildSexualAbuseEvent .
                FILTER NOT EXISTS {
                    ?victimRole a cacontology-gufo:VictimRole ;
                               cacontology-gufo:participatesInEvent ?this .
                } FILTER NOT EXISTS {
                    ?offenderRole a cacontology-gufo:OffenderRole ;
                                 cacontology-gufo:participatesInEvent ?this .
                }
            }
        """
    ] .

# Specific Criminal Event Shapes
cacontology-gufo:CSAMIncidentShape rdf:type sh:NodeShape ;
    rdfs:label "CSAM Incident Shape"@en ;
    sh:targetClass cacontology-gufo:CSAMIncident ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:SubKind ;
        sh:minCount 1 ;
        sh:message "CSAM Incident must be gUFO SubKind"@en
    ] ;
    sh:property [
        sh:path uco-core:hasFacet ;
        sh:minCount 1 ;
        sh:message "CSAM incident must have digital artifact facets"@en
    ] .

cacontology-gufo:GroomingSolicitationShape rdf:type sh:NodeShape ;
    rdfs:label "Grooming Solicitation Shape"@en ;
    sh:targetClass cacontology-gufo:GroomingSolicitation ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:SubKind ;
        sh:minCount 1 ;
        sh:message "Grooming Solicitation must be gUFO SubKind"@en
    ] ;
    sh:property [
        sh:path cacontology-gufo:participatesInEvent ;
        sh:minCount 2 ;
        sh:message "Grooming must involve at least victim and offender"@en
    ] .

cacontology-gufo:SextortionShape rdf:type sh:NodeShape ;
    rdfs:label "Sextortion Shape"@en ;
    sh:targetClass cacontology-gufo:Sextortion ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue gufo:SubKind ;
        sh:minCount 1 ;
        sh:message "Sextortion must be gUFO SubKind"@en
    ] .

# =============================================================================
# TEMPORAL CONSISTENCY VALIDATION
# =============================================================================

# Investigation Temporal Consistency
cacontology-gufo:InvestigationTemporalConsistencyShape rdf:type sh:NodeShape ;
    rdfs:label "Investigation Temporal Consistency Shape"@en ;
    sh:targetClass cacontology-gufo:Investigation ;
    sh:sparql [
        sh:message "Investigation events must occur within phase timeframes"@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "cacontology-gufo" ;
                sh:namespace "https://cacontology.projectvic.org/gufo#"^^xsd:anyURI
            ] ,
            [
                sh:prefix "gufo" ;
                sh:namespace "http://purl.org/nemo/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this cacontology-gufo:hasPhase ?phase .
                ?phase cacontology-gufo:hasPhaseBeginPoint ?phaseBegin ;
                       cacontology-gufo:hasPhaseEndPoint ?phaseEnd .
                ?event cacontology-gufo:occursInSituation ?situation .
                ?event gufo:hasBeginPointInXSDDateTimeStamp ?eventBegin .
                FILTER (?eventBegin < ?phaseBegin || ?eventBegin > ?phaseEnd)
            }
        """
    ] .

# =============================================================================
# FOUNDATIONAL TYPE COMPLIANCE
# =============================================================================

# gUFO Type Consistency Shape
cacontology-gufo:FoundationalTypeConsistencyShape rdf:type sh:NodeShape ;
    rdfs:label "gUFO Foundational Type Consistency Shape"@en ;
    sh:targetNode cacontology-gufo:Investigation ;
    sh:sparql [
        sh:message "All gUFO entities must have proper foundational typing"@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "gufo" ;
                sh:namespace "http://purl.org/nemo/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            SELECT ?entity
            WHERE {
                {
                    ?entity a gufo:Kind .
                    FILTER NOT EXISTS { ?entity a gufo:Object . }
                } UNION {
                    ?entity a gufo:Phase .
                    FILTER NOT EXISTS { ?entity a gufo:AntiRigidType . }
                } UNION {
                    ?entity a gufo:Role .
                    FILTER NOT EXISTS { ?entity a gufo:AntiRigidType . }
                } UNION {
                    ?entity a gufo:Event .
                    FILTER NOT EXISTS { ?entity a gufo:Perdurant . }
                } UNION {
                    ?entity a gufo:Situation .
                    FILTER NOT EXISTS { ?entity a gufo:SituationType . }
                }
            }
        """
    ] .

# =============================================================================
# CROSS-REFERENCE VALIDATION
# =============================================================================

# Investigation Completeness Shape
cacontology-gufo:InvestigationCompletenessShape rdf:type sh:NodeShape ;
    rdfs:label "Investigation Completeness Shape"@en ;
    sh:targetClass cacontology-gufo:Investigation ;
    sh:sparql [
        sh:message "Investigation must have coherent role and event participation"@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "cacontology-gufo" ;
                sh:namespace "https://cacontology.projectvic.org/gufo#"^^xsd:anyURI
            ] ;
            sh:declare [
                sh:prefix "cacontology-gufo" ;
                sh:namespace "https://cacontology.projectvic.org/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            PREFIX cacontology-gufo: <https://cacontology.projectvic.org/gufo#>
            PREFIX gufo: <http://purl.org/nemo/gufo#>
            SELECT ?this
            WHERE {
                ?this cacontology-gufo:hasRole ?role .
                ?role cacontology-gufo:participatesInInvestigation ?this .
                FILTER NOT EXISTS {
                    ?role cacontology-gufo:participatesInEvent ?event .
                    ?event a gufo:Event .
                }
            }
        """
    ] . 

# =============================================================================
# AGE-AT-TIME SITUATION VALIDATION
# =============================================================================

# Age At Time Situation Shape
cacontology-gufo:AgeAtTimeSituationShape rdf:type sh:NodeShape ;
    rdfs:label "Age At Time Situation Shape"@en ;
    sh:targetClass cacontology-temporal:AgeAtTimeSituation ;
    sh:property [
        sh:path cacontology-temporal:ageSubject ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class uco-identity:Person ;
        sh:message "AgeAtTimeSituation must be linked to exactly one person via cacontology-temporal:ageSubject."@en
    ] ;
    sh:property [
        sh:path cacontology-temporal:hasAgeInYears ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0.0 ;
        sh:message "AgeAtTimeSituation must have exactly one non-negative numeric age value in years via cacontology-temporal:hasAgeInYears."@en
    ] ;
    sh:property [
        sh:path gufo:hasBeginPointInXSDDateTimeStamp ;
        sh:datatype xsd:dateTimeStamp ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "AgeAtTimeSituation must have a begin timestamp (when the attributed age becomes valid)."@en
    ] ;
    sh:property [
        sh:path gufo:hasEndPointInXSDDateTimeStamp ;
        sh:datatype xsd:dateTimeStamp ;
        sh:maxCount 1 ;
        sh:message "AgeAtTimeSituation may have at most one end timestamp (when the attributed age ceases to be valid)."@en
    ] ;
    sh:property [
        sh:path cacontology-temporal:concernsAgeQuality ;
        sh:maxCount 1 ;
        sh:hasValue cacontology-temporal:Age ;
        sh:message "AgeAtTimeSituation, when specifying a quality type, MUST use cacontology-temporal:Age via cacontology-temporal:concernsAgeQuality (a subproperty of gufo:concernsQualityType)."@en
    ] ;
    # Temporal consistency: begin must precede end when both are present
    sh:sparql [
        sh:message "For AgeAtTimeSituation, the begin timestamp must be strictly earlier than the end timestamp when both are present."@en ;
        sh:prefixes [
            sh:declare [
                sh:prefix "cacontology-temporal" ;
                sh:namespace "https://cacontology.projectvic.org/temporal#"^^xsd:anyURI
            ] , [
                sh:prefix "gufo" ;
                sh:namespace "http://purl.org/nemo/gufo#"^^xsd:anyURI
            ]
        ] ;
        sh:select """
            SELECT ?this
            WHERE {
                ?this gufo:hasBeginPointInXSDDateTimeStamp ?begin .
                ?this gufo:hasEndPointInXSDDateTimeStamp ?end .
                FILTER (?begin >= ?end)
            }
        """
    ] .